"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.request = exports.sendRequest = void 0;
/* istanbul ignore file */
/* tslint:disable */
/* eslint-disable */
const ApiError_1 = require("./ApiError");
const CancelablePromise_1 = require("./CancelablePromise");
const isDefined = (value) => {
    return value !== undefined && value !== null;
};
const isString = (value) => {
    return typeof value === 'string';
};
const isStringWithValue = (value) => {
    return isString(value) && value !== '';
};
const isBlob = (value) => {
    return (typeof value === 'object' &&
        typeof value.type === 'string' &&
        typeof value.stream === 'function' &&
        typeof value.arrayBuffer === 'function' &&
        typeof value.constructor === 'function' &&
        typeof value.constructor.name === 'string' &&
        /^(Blob|File)$/.test(value.constructor.name) &&
        /^(Blob|File)$/.test(value[Symbol.toStringTag]));
};
const isFormData = (value) => {
    return value instanceof FormData;
};
const base64 = (str) => {
    try {
        return btoa(str);
    }
    catch (err) {
        // @ts-ignore
        return Buffer.from(str).toString('base64');
    }
};
const getQueryString = (params) => {
    const qs = [];
    const append = (key, value) => {
        qs.push(`${encodeURIComponent(key)}=${encodeURIComponent(String(value))}`);
    };
    const process = (key, value) => {
        if (isDefined(value)) {
            if (Array.isArray(value)) {
                value.forEach(v => {
                    process(key, v);
                });
            }
            else if (typeof value === 'object') {
                Object.entries(value).forEach(([k, v]) => {
                    process(`${key}[${k}]`, v);
                });
            }
            else {
                append(key, value);
            }
        }
    };
    Object.entries(params).forEach(([key, value]) => {
        process(key, value);
    });
    if (qs.length > 0) {
        return `?${qs.join('&')}`;
    }
    return '';
};
const getUrl = (config, options) => {
    const encoder = config.ENCODE_PATH || encodeURI;
    const path = options.url
        .replace('{api-version}', config.VERSION)
        .replace(/{(.*?)}/g, (substring, group) => {
        if (options.path?.hasOwnProperty(group)) {
            return encoder(String(options.path[group]));
        }
        return substring;
    });
    const url = `${config.BASE}${path}`;
    if (options.query) {
        return `${url}${getQueryString(options.query)}`;
    }
    return url;
};
const getFormData = (options) => {
    if (options.formData) {
        const formData = new FormData();
        const process = (key, value) => {
            if (isString(value) || isBlob(value)) {
                formData.append(key, value);
            }
            else {
                formData.append(key, JSON.stringify(value));
            }
        };
        Object.entries(options.formData)
            .filter(([_, value]) => isDefined(value))
            .forEach(([key, value]) => {
            if (Array.isArray(value)) {
                value.forEach(v => process(key, v));
            }
            else {
                process(key, value);
            }
        });
        return formData;
    }
    return undefined;
};
const resolve = async (options, resolver) => {
    if (typeof resolver === 'function') {
        return resolver(options);
    }
    return resolver;
};
const getHeaders = async (config, options) => {
    const token = await resolve(options, config.TOKEN);
    const username = await resolve(options, config.USERNAME);
    const password = await resolve(options, config.PASSWORD);
    const additionalHeaders = await resolve(options, config.HEADERS);
    const headers = Object.entries({
        Accept: 'application/json',
        ...additionalHeaders,
        ...options.headers,
    })
        .filter(([_, value]) => isDefined(value))
        .reduce((headers, [key, value]) => ({
        ...headers,
        [key]: String(value),
    }), {});
    if (isStringWithValue(token)) {
        headers['Authorization'] = `Bearer ${token}`;
    }
    if (isStringWithValue(username) && isStringWithValue(password)) {
        const credentials = base64(`${username}:${password}`);
        headers['Authorization'] = `Basic ${credentials}`;
    }
    if (options.body) {
        if (options.mediaType) {
            headers['Content-Type'] = options.mediaType;
        }
        else if (isBlob(options.body)) {
            headers['Content-Type'] = options.body.type || 'application/octet-stream';
        }
        else if (isString(options.body)) {
            headers['Content-Type'] = 'text/plain';
        }
        else if (!isFormData(options.body)) {
            headers['Content-Type'] = 'application/json';
        }
    }
    return new Headers(headers);
};
const getRequestBody = (options) => {
    if (options.body) {
        if (options.mediaType?.includes('/json')) {
            return JSON.stringify(options.body);
        }
        else if (isString(options.body) || isBlob(options.body) || isFormData(options.body)) {
            return options.body;
        }
        else {
            return JSON.stringify(options.body);
        }
    }
    return undefined;
};
const sendRequest = async (config, options, url, body, formData, headers, onCancel) => {
    const controller = new AbortController();
    const request = {
        headers,
        body: body ?? formData,
        method: options.method,
        signal: controller.signal,
    };
    if (config.WITH_CREDENTIALS) {
        request.credentials = config.CREDENTIALS;
    }
    onCancel(() => controller.abort());
    return await fetch(url, request);
};
exports.sendRequest = sendRequest;
const getResponseHeader = (response, responseHeader) => {
    if (responseHeader) {
        const content = response.headers.get(responseHeader);
        if (isString(content)) {
            return content;
        }
    }
    return undefined;
};
const getResponseBody = async (response) => {
    if (response.status !== 204) {
        try {
            const contentType = response.headers.get('Content-Type');
            if (contentType) {
                const isJSON = contentType.toLowerCase().startsWith('application/json');
                if (isJSON) {
                    return await response.json();
                }
                else {
                    return await response.text();
                }
            }
        }
        catch (error) {
            console.error(error);
        }
    }
    return undefined;
};
const catchErrorCodes = (options, result) => {
    const errors = {
        400: 'Bad Request',
        401: 'Unauthorized',
        403: 'Forbidden',
        404: 'Not Found',
        500: 'Internal Server Error',
        502: 'Bad Gateway',
        503: 'Service Unavailable',
        ...options.errors,
    };
    const error = errors[result.status];
    if (error) {
        throw new ApiError_1.ApiError(options, result, error);
    }
    if (!result.ok) {
        throw new ApiError_1.ApiError(options, result, 'Generic Error');
    }
};
/**
 * Request method
 * @param config The OpenAPI configuration object
 * @param options The request options from the service
 * @returns CancelablePromise<T>
 * @throws ApiError
 */
const request = (config, options) => {
    return new CancelablePromise_1.CancelablePromise(async (resolve, reject, onCancel) => {
        try {
            const url = getUrl(config, options);
            const formData = getFormData(options);
            const body = getRequestBody(options);
            const headers = await getHeaders(config, options);
            if (!onCancel.isCancelled) {
                const response = await (0, exports.sendRequest)(config, options, url, body, formData, headers, onCancel);
                const responseBody = await getResponseBody(response);
                const responseHeader = getResponseHeader(response, options.responseHeader);
                const result = {
                    url,
                    ok: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    body: responseHeader ?? responseBody,
                };
                catchErrorCodes(options, result);
                resolve(result.body);
            }
        }
        catch (error) {
            reject(error);
        }
    });
};
exports.request = request;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2dlbi9jb3JlL3JlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMEJBQTBCO0FBQzFCLG9CQUFvQjtBQUNwQixvQkFBb0I7QUFDcEIseUNBQXNDO0FBR3RDLDJEQUF3RDtBQUl4RCxNQUFNLFNBQVMsR0FBRyxDQUFJLEtBQTJCLEVBQXlDLEVBQUU7SUFDMUYsT0FBTyxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssS0FBSyxJQUFJLENBQUM7QUFDL0MsQ0FBQyxDQUFDO0FBRUYsTUFBTSxRQUFRLEdBQUcsQ0FBQyxLQUFVLEVBQW1CLEVBQUU7SUFDL0MsT0FBTyxPQUFPLEtBQUssS0FBSyxRQUFRLENBQUM7QUFDbkMsQ0FBQyxDQUFDO0FBRUYsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLEtBQVUsRUFBbUIsRUFBRTtJQUN4RCxPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLEtBQUssRUFBRSxDQUFDO0FBQ3pDLENBQUMsQ0FBQztBQUVGLE1BQU0sTUFBTSxHQUFHLENBQUMsS0FBVSxFQUFpQixFQUFFO0lBQzNDLE9BQU8sQ0FDTCxPQUFPLEtBQUssS0FBSyxRQUFRO1FBQ3pCLE9BQU8sS0FBSyxDQUFDLElBQUksS0FBSyxRQUFRO1FBQzlCLE9BQU8sS0FBSyxDQUFDLE1BQU0sS0FBSyxVQUFVO1FBQ2xDLE9BQU8sS0FBSyxDQUFDLFdBQVcsS0FBSyxVQUFVO1FBQ3ZDLE9BQU8sS0FBSyxDQUFDLFdBQVcsS0FBSyxVQUFVO1FBQ3ZDLE9BQU8sS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEtBQUssUUFBUTtRQUMxQyxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1FBQzVDLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUNoRCxDQUFDO0FBQ0osQ0FB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QUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDNUYsTUFBTSxZQUFZLEdBQUcsTUFBTSxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3JELE1BQU0sY0FBYyxHQUFHLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBRTNFLE1BQU0sTUFBTSxHQUFjO29CQUN4QixHQUFHO29CQUNILEVBQUUsRUFBRSxRQUFRLENBQUMsRUFBRTtvQkFDZixNQUFNLEVBQUUsUUFBUSxDQUFDLE1BQU07b0JBQ3ZCLFVBQVUsRUFBRSxRQUFRLENBQUMsVUFBVTtvQkFDL0IsSUFBSSxFQUFFLGNBQWMsSUFBSSxZQUFZO2lCQUNyQyxDQUFDO2dCQUVGLGVBQWUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7Z0JBRWpDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDdEI7U0FDRjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2Y7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQTdCVyxRQUFBLE9BQU8sV0E2QmxCIiwic291cmNlc0NvbnRlbnQiOlsiLyogaXN0YW5idWwgaWdub3JlIGZpbGUgKi9cbi8qIHRzbGludDpkaXNhYmxlICovXG4vKiBlc2xpbnQtZGlzYWJsZSAqL1xuaW1wb3J0IHsgQXBpRXJyb3IgfSBmcm9tICcuL0FwaUVycm9yJztcbmltcG9ydCB0eXBlIHsgQXBpUmVxdWVzdE9wdGlvbnMgfSBmcm9tICcuL0FwaVJlcXVlc3RPcHRpb25zJztcbmltcG9ydCB0eXBlIHsgQXBpUmVzdWx0IH0gZnJvbSAnLi9BcGlSZXN1bHQnO1xuaW1wb3J0IHsgQ2FuY2VsYWJsZVByb21pc2UgfSBmcm9tICcuL0NhbmNlbGFibGVQcm9taXNlJztcbmltcG9ydCB0eXBlIHsgT25DYW5jZWwgfSBmcm9tICcuL0NhbmNlbGFibGVQcm9taXNlJztcbmltcG9ydCB0eXBlIHsgT3BlbkFQSUNvbmZpZyB9IGZyb20gJy4vT3BlbkFQSSc7XG5cbmNvbnN0IGlzRGVmaW5lZCA9IDxUPih2YWx1ZTogVCB8IG51bGwgfCB1bmRlZmluZWQpOiB2YWx1ZSBpcyBFeGNsdWRlPFQsIG51bGwgfCB1bmRlZmluZWQ+ID0+IHtcbiAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGw7XG59O1xuXG5jb25zdCBpc1N0cmluZyA9ICh2YWx1ZTogYW55KTogdmFsdWUgaXMgc3RyaW5nID0+IHtcbiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZyc7XG59O1xuXG5jb25zdCBpc1N0cmluZ1dpdGhWYWx1ZSA9ICh2YWx1ZTogYW55KTogdmFsdWUgaXMgc3RyaW5nID0+IHtcbiAgcmV0dXJuIGlzU3RyaW5nKHZhbHVlKSAmJiB2YWx1ZSAhPT0gJyc7XG59O1xuXG5jb25zdCBpc0Jsb2IgPSAodmFsdWU6IGFueSk6IHZhbHVlIGlzIEJsb2IgPT4ge1xuICByZXR1cm4gKFxuICAgIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiZcbiAgICB0eXBlb2YgdmFsdWUudHlwZSA9PT0gJ3N0cmluZycgJiZcbiAgICB0eXBlb2YgdmFsdWUuc3RyZWFtID09PSAnZnVuY3Rpb24nICYmXG4gICAgdHlwZW9mIHZhbHVlLmFycmF5QnVmZmVyID09PSAnZnVuY3Rpb24nICYmXG4gICAgdHlwZW9mIHZhbHVlLmNvbnN0cnVjdG9yID09PSAnZnVuY3Rpb24nICYmXG4gICAgdHlwZW9mIHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgPT09ICdzdHJpbmcnICYmXG4gICAgL14oQmxvYnxGaWxlKSQvLnRlc3QodmFsdWUuY29uc3RydWN0b3IubmFtZSkgJiZcbiAgICAvXihCbG9ifEZpbGUpJC8udGVzdCh2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddKVxuICApO1xufTtcblxuY29uc3QgaXNGb3JtRGF0YSA9ICh2YWx1ZTogYW55KTogdmFsdWUgaXMgRm9ybURhdGEgPT4ge1xuICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBGb3JtRGF0YTtcbn07XG5cbmNvbnN0IGJhc2U2NCA9IChzdHI6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGJ0b2Eoc3RyKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgfVxufTtcblxuY29uc3QgZ2V0UXVlcnlTdHJpbmcgPSAocGFyYW1zOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogc3RyaW5nID0+IHtcbiAgY29uc3QgcXM6IHN0cmluZ1tdID0gW107XG5cbiAgY29uc3QgYXBwZW5kID0gKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSA9PiB7XG4gICAgcXMucHVzaChgJHtlbmNvZGVVUklDb21wb25lbnQoa2V5KX09JHtlbmNvZGVVUklDb21wb25lbnQoU3RyaW5nKHZhbHVlKSl9YCk7XG4gIH07XG5cbiAgY29uc3QgcHJvY2VzcyA9IChrZXk6IHN0cmluZywgdmFsdWU6IGFueSkgPT4ge1xuICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgdmFsdWUuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgICBwcm9jZXNzKGtleSwgdik7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIE9iamVjdC5lbnRyaWVzKHZhbHVlKS5mb3JFYWNoKChbaywgdl0pID0+IHtcbiAgICAgICAgICBwcm9jZXNzKGAke2tleX1bJHtrfV1gLCB2KTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhcHBlbmQoa2V5LCB2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIE9iamVjdC5lbnRyaWVzKHBhcmFtcykuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgcHJvY2VzcyhrZXksIHZhbHVlKTtcbiAgfSk7XG5cbiAgaWYgKHFzLmxlbmd0aCA+IDApIHtcbiAgICByZXR1cm4gYD8ke3FzLmpvaW4oJyYnKX1gO1xuICB9XG5cbiAgcmV0dXJuICcnO1xufTtcblxuY29uc3QgZ2V0VXJsID0gKGNvbmZpZzogT3BlbkFQSUNvbmZpZywgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMpOiBzdHJpbmcgPT4ge1xuICBjb25zdCBlbmNvZGVyID0gY29uZmlnLkVOQ09ERV9QQVRIIHx8IGVuY29kZVVSSTtcblxuICBjb25zdCBwYXRoID0gb3B0aW9ucy51cmxcbiAgICAucmVwbGFjZSgne2FwaS12ZXJzaW9ufScsIGNvbmZpZy5WRVJTSU9OKVxuICAgIC5yZXBsYWNlKC97KC4qPyl9L2csIChzdWJzdHJpbmc6IHN0cmluZywgZ3JvdXA6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKG9wdGlvbnMucGF0aD8uaGFzT3duUHJvcGVydHkoZ3JvdXApKSB7XG4gICAgICAgIHJldHVybiBlbmNvZGVyKFN0cmluZyhvcHRpb25zLnBhdGhbZ3JvdXBdKSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gc3Vic3RyaW5nO1xuICAgIH0pO1xuXG4gIGNvbnN0IHVybCA9IGAke2NvbmZpZy5CQVNFfSR7cGF0aH1gO1xuICBpZiAob3B0aW9ucy5xdWVyeSkge1xuICAgIHJldHVybiBgJHt1cmx9JHtnZXRRdWVyeVN0cmluZyhvcHRpb25zLnF1ZXJ5KX1gO1xuICB9XG4gIHJldHVybiB1cmw7XG59O1xuXG5jb25zdCBnZXRGb3JtRGF0YSA9IChvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyk6IEZvcm1EYXRhIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKG9wdGlvbnMuZm9ybURhdGEpIHtcbiAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuXG4gICAgY29uc3QgcHJvY2VzcyA9IChrZXk6IHN0cmluZywgdmFsdWU6IGFueSkgPT4ge1xuICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSB8fCBpc0Jsb2IodmFsdWUpKSB7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZChrZXksIHZhbHVlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZChrZXksIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIE9iamVjdC5lbnRyaWVzKG9wdGlvbnMuZm9ybURhdGEpXG4gICAgICAuZmlsdGVyKChbXywgdmFsdWVdKSA9PiBpc0RlZmluZWQodmFsdWUpKVxuICAgICAgLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICB2YWx1ZS5mb3JFYWNoKHYgPT4gcHJvY2VzcyhrZXksIHYpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBwcm9jZXNzKGtleSwgdmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIHJldHVybiBmb3JtRGF0YTtcbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufTtcblxudHlwZSBSZXNvbHZlcjxUPiA9IChvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucykgPT4gUHJvbWlzZTxUPjtcblxuY29uc3QgcmVzb2x2ZSA9IGFzeW5jIDxUPihvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucywgcmVzb2x2ZXI/OiBUIHwgUmVzb2x2ZXI8VD4pOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+ID0+IHtcbiAgaWYgKHR5cGVvZiByZXNvbHZlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiAocmVzb2x2ZXIgYXMgUmVzb2x2ZXI8VD4pKG9wdGlvbnMpO1xuICB9XG4gIHJldHVybiByZXNvbHZlcjtcbn07XG5cbmNvbnN0IGdldEhlYWRlcnMgPSBhc3luYyAoY29uZmlnOiBPcGVuQVBJQ29uZmlnLCBvcHRpb25zOiBBcGlSZXF1ZXN0T3B0aW9ucyk6IFByb21pc2U8SGVhZGVycz4gPT4ge1xuICBjb25zdCB0b2tlbiA9IGF3YWl0IHJlc29sdmUob3B0aW9ucywgY29uZmlnLlRPS0VOKTtcbiAgY29uc3QgdXNlcm5hbWUgPSBhd2FpdCByZXNvbHZlKG9wdGlvbnMsIGNvbmZpZy5VU0VSTkFNRSk7XG4gIGNvbnN0IHBhc3N3b3JkID0gYXdhaXQgcmVzb2x2ZShvcHRpb25zLCBjb25maWcuUEFTU1dPUkQpO1xuICBjb25zdCBhZGRpdGlvbmFsSGVhZGVycyA9IGF3YWl0IHJlc29sdmUob3B0aW9ucywgY29uZmlnLkhFQURFUlMpO1xuXG4gIGNvbnN0IGhlYWRlcnMgPSBPYmplY3QuZW50cmllcyh7XG4gICAgQWNjZXB0OiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgLi4uYWRkaXRpb25hbEhlYWRlcnMsXG4gICAgLi4ub3B0aW9ucy5oZWFkZXJzLFxuICB9KVxuICAgIC5maWx0ZXIoKFtfLCB2YWx1ZV0pID0+IGlzRGVmaW5lZCh2YWx1ZSkpXG4gICAgLnJlZHVjZSgoaGVhZGVycywgW2tleSwgdmFsdWVdKSA9PiAoe1xuICAgICAgLi4uaGVhZGVycyxcbiAgICAgIFtrZXldOiBTdHJpbmcodmFsdWUpLFxuICAgIH0pLCB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KTtcblxuICBpZiAoaXNTdHJpbmdXaXRoVmFsdWUodG9rZW4pKSB7XG4gICAgaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gYEJlYXJlciAke3Rva2VufWA7XG4gIH1cblxuICBpZiAoaXNTdHJpbmdXaXRoVmFsdWUodXNlcm5hbWUpICYmIGlzU3RyaW5nV2l0aFZhbHVlKHBhc3N3b3JkKSkge1xuICAgIGNvbnN0IGNyZWRlbnRpYWxzID0gYmFzZTY0KGAke3VzZXJuYW1lfToke3Bhc3N3b3JkfWApO1xuICAgIGhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9IGBCYXNpYyAke2NyZWRlbnRpYWxzfWA7XG4gIH1cblxuICBpZiAob3B0aW9ucy5ib2R5KSB7XG4gICAgaWYgKG9wdGlvbnMubWVkaWFUeXBlKSB7XG4gICAgICBoZWFkZXJzWydDb250ZW50LVR5cGUnXSA9IG9wdGlvbnMubWVkaWFUeXBlO1xuICAgIH0gZWxzZSBpZiAoaXNCbG9iKG9wdGlvbnMuYm9keSkpIHtcbiAgICAgIGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gb3B0aW9ucy5ib2R5LnR5cGUgfHwgJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7XG4gICAgfSBlbHNlIGlmIChpc1N0cmluZyhvcHRpb25zLmJvZHkpKSB7XG4gICAgICBoZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICd0ZXh0L3BsYWluJztcbiAgICB9IGVsc2UgaWYgKCFpc0Zvcm1EYXRhKG9wdGlvbnMuYm9keSkpIHtcbiAgICAgIGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBuZXcgSGVhZGVycyhoZWFkZXJzKTtcbn07XG5cbmNvbnN0IGdldFJlcXVlc3RCb2R5ID0gKG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zKTogYW55ID0+IHtcbiAgaWYgKG9wdGlvbnMuYm9keSkge1xuICAgIGlmIChvcHRpb25zLm1lZGlhVHlwZT8uaW5jbHVkZXMoJy9qc29uJykpIHtcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvcHRpb25zLmJvZHkpXG4gICAgfSBlbHNlIGlmIChpc1N0cmluZyhvcHRpb25zLmJvZHkpIHx8IGlzQmxvYihvcHRpb25zLmJvZHkpIHx8IGlzRm9ybURhdGEob3B0aW9ucy5ib2R5KSkge1xuICAgICAgcmV0dXJuIG9wdGlvbnMuYm9keTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYm9keSk7XG4gICAgfVxuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59O1xuXG5leHBvcnQgY29uc3Qgc2VuZFJlcXVlc3QgPSBhc3luYyAoXG4gIGNvbmZpZzogT3BlbkFQSUNvbmZpZyxcbiAgb3B0aW9uczogQXBpUmVxdWVzdE9wdGlvbnMsXG4gIHVybDogc3RyaW5nLFxuICBib2R5OiBhbnksXG4gIGZvcm1EYXRhOiBGb3JtRGF0YSB8IHVuZGVmaW5lZCxcbiAgaGVhZGVyczogSGVhZGVycyxcbiAgb25DYW5jZWw6IE9uQ2FuY2VsXG4pOiBQcm9taXNlPFJlc3BvbnNlPiA9PiB7XG4gIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG5cbiAgY29uc3QgcmVxdWVzdDogUmVxdWVzdEluaXQgPSB7XG4gICAgaGVhZGVycyxcbiAgICBib2R5OiBib2R5ID8/IGZvcm1EYXRhLFxuICAgIG1ldGhvZDogb3B0aW9ucy5tZXRob2QsXG4gICAgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbCxcbiAgfTtcblxuICBpZiAoY29uZmlnLldJVEhfQ1JFREVOVElBTFMpIHtcbiAgICByZXF1ZXN0LmNyZWRlbnRpYWxzID0gY29uZmlnLkNSRURFTlRJQUxTO1xuICB9XG5cbiAgb25DYW5jZWwoKCkgPT4gY29udHJvbGxlci5hYm9ydCgpKTtcblxuICByZXR1cm4gYXdhaXQgZmV0Y2godXJsLCByZXF1ZXN0KTtcbn07XG5cbmNvbnN0IGdldFJlc3BvbnNlSGVhZGVyID0gKHJlc3BvbnNlOiBSZXNwb25zZSwgcmVzcG9uc2VIZWFkZXI/OiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAocmVzcG9uc2VIZWFkZXIpIHtcbiAgICBjb25zdCBjb250ZW50ID0gcmVzcG9uc2UuaGVhZGVycy5nZXQocmVzcG9uc2VIZWFkZXIpO1xuICAgIGlmIChpc1N0cmluZyhjb250ZW50KSkge1xuICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgfVxuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59O1xuXG5jb25zdCBnZXRSZXNwb25zZUJvZHkgPSBhc3luYyAocmVzcG9uc2U6IFJlc3BvbnNlKTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjA0KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoJ0NvbnRlbnQtVHlwZScpO1xuICAgICAgaWYgKGNvbnRlbnRUeXBlKSB7XG4gICAgICAgIGNvbnN0IGlzSlNPTiA9IGNvbnRlbnRUeXBlLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCgnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgICBpZiAoaXNKU09OKSB7XG4gICAgICAgICAgcmV0dXJuIGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufTtcblxuY29uc3QgY2F0Y2hFcnJvckNvZGVzID0gKG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zLCByZXN1bHQ6IEFwaVJlc3VsdCk6IHZvaWQgPT4ge1xuICBjb25zdCBlcnJvcnM6IFJlY29yZDxudW1iZXIsIHN0cmluZz4gPSB7XG4gICAgNDAwOiAnQmFkIFJlcXVlc3QnLFxuICAgIDQwMTogJ1VuYXV0aG9yaXplZCcsXG4gICAgNDAzOiAnRm9yYmlkZGVuJyxcbiAgICA0MDQ6ICdOb3QgRm91bmQnLFxuICAgIDUwMDogJ0ludGVybmFsIFNlcnZlciBFcnJvcicsXG4gICAgNTAyOiAnQmFkIEdhdGV3YXknLFxuICAgIDUwMzogJ1NlcnZpY2UgVW5hdmFpbGFibGUnLFxuICAgIC4uLm9wdGlvbnMuZXJyb3JzLFxuICB9XG5cbiAgY29uc3QgZXJyb3IgPSBlcnJvcnNbcmVzdWx0LnN0YXR1c107XG4gIGlmIChlcnJvcikge1xuICAgIHRocm93IG5ldyBBcGlFcnJvcihvcHRpb25zLCByZXN1bHQsIGVycm9yKTtcbiAgfVxuXG4gIGlmICghcmVzdWx0Lm9rKSB7XG4gICAgdGhyb3cgbmV3IEFwaUVycm9yKG9wdGlvbnMsIHJlc3VsdCwgJ0dlbmVyaWMgRXJyb3InKTtcbiAgfVxufTtcblxuLyoqXG4gKiBSZXF1ZXN0IG1ldGhvZFxuICogQHBhcmFtIGNvbmZpZyBUaGUgT3BlbkFQSSBjb25maWd1cmF0aW9uIG9iamVjdFxuICogQHBhcmFtIG9wdGlvbnMgVGhlIHJlcXVlc3Qgb3B0aW9ucyBmcm9tIHRoZSBzZXJ2aWNlXG4gKiBAcmV0dXJucyBDYW5jZWxhYmxlUHJvbWlzZTxUPlxuICogQHRocm93cyBBcGlFcnJvclxuICovXG5leHBvcnQgY29uc3QgcmVxdWVzdCA9IDxUPihjb25maWc6IE9wZW5BUElDb25maWcsIG9wdGlvbnM6IEFwaVJlcXVlc3RPcHRpb25zKTogQ2FuY2VsYWJsZVByb21pc2U8VD4gPT4ge1xuICByZXR1cm4gbmV3IENhbmNlbGFibGVQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QsIG9uQ2FuY2VsKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVybCA9IGdldFVybChjb25maWcsIG9wdGlvbnMpO1xuICAgICAgY29uc3QgZm9ybURhdGEgPSBnZXRGb3JtRGF0YShvcHRpb25zKTtcbiAgICAgIGNvbnN0IGJvZHkgPSBnZXRSZXF1ZXN0Qm9keShvcHRpb25zKTtcbiAgICAgIGNvbnN0IGhlYWRlcnMgPSBhd2FpdCBnZXRIZWFkZXJzKGNvbmZpZywgb3B0aW9ucyk7XG5cbiAgICAgIGlmICghb25DYW5jZWwuaXNDYW5jZWxsZWQpIHtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzZW5kUmVxdWVzdChjb25maWcsIG9wdGlvbnMsIHVybCwgYm9keSwgZm9ybURhdGEsIGhlYWRlcnMsIG9uQ2FuY2VsKTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2VCb2R5ID0gYXdhaXQgZ2V0UmVzcG9uc2VCb2R5KHJlc3BvbnNlKTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2VIZWFkZXIgPSBnZXRSZXNwb25zZUhlYWRlcihyZXNwb25zZSwgb3B0aW9ucy5yZXNwb25zZUhlYWRlcik7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0OiBBcGlSZXN1bHQgPSB7XG4gICAgICAgICAgdXJsLFxuICAgICAgICAgIG9rOiByZXNwb25zZS5vayxcbiAgICAgICAgICBzdGF0dXM6IHJlc3BvbnNlLnN0YXR1cyxcbiAgICAgICAgICBzdGF0dXNUZXh0OiByZXNwb25zZS5zdGF0dXNUZXh0LFxuICAgICAgICAgIGJvZHk6IHJlc3BvbnNlSGVhZGVyID8/IHJlc3BvbnNlQm9keSxcbiAgICAgICAgfTtcblxuICAgICAgICBjYXRjaEVycm9yQ29kZXMob3B0aW9ucywgcmVzdWx0KTtcblxuICAgICAgICByZXNvbHZlKHJlc3VsdC5ib2R5KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICB9XG4gIH0pO1xufTtcbiJdfQ==